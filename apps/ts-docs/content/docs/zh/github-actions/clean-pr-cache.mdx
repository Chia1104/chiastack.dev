---
title: Clean PR Cache
description: 清理特定 PR 分支的 GitHub Actions 快取
---

`clean-pr-cache` action 可協助您清理特定 pull request 分支的 GitHub Actions 快取。這對於管理快取儲存空間和確保乾淨的建置非常有用。

## 概述

此 action 使用 GitHub CLI (`gh`) 和 `actions-cache` 擴充功能來列出和刪除與特定 PR 分支相關的快取項目。

## 輸入參數

| 參數 | 說明 | 必填 | 預設值 |
|------|------|------|--------|
| `REPO` | 儲存庫名稱，格式為 `owner/repo`（例如：`chia1104/chiastack.dev`） | 是 | - |
| `BRANCH` | 分支引用，格式為 `refs/pull/123/merge` | 是 | - |
| `GH_TOKEN` | 用於身份驗證的 GitHub token。使用 `${{ secrets.GITHUB_TOKEN }}` 作為預設 token | 是 | - |

## 使用方法

### 在同一個儲存庫中使用

如果您在定義此 action 的同一個儲存庫中使用：

```yaml
name: Cleanup PR Caches

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Cleanup PR caches
        uses: ./.github/actions/clean-pr-cache
        with:
          REPO: ${{ github.repository }}
          BRANCH: "refs/pull/${{ github.event.pull_request.number }}/merge"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 從外部儲存庫使用

要在外部儲存庫中使用此 action，請使用完整路徑引用：

```yaml
name: Cleanup PR Caches

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Cleanup PR caches
        uses: chia1104/chiastack.dev/.github/actions/clean-pr-cache@main
        with:
          REPO: ${{ github.repository }}
          BRANCH: "refs/pull/${{ github.event.pull_request.number }}/merge"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

請將 `chia1104/chiastack.dev` 替換為您的儲存庫擁有者和名稱，並將 `@main` 替換為您要使用的分支或標籤。

### 使用特定版本

為了更好的穩定性，您可以固定到特定的 commit SHA 或標籤：

```yaml
- name: Cleanup PR caches
  uses: chia1104/chiastack.dev/.github/actions/clean-pr-cache@v1.0.0
  with:
    REPO: ${{ github.repository }}
    BRANCH: "refs/pull/${{ github.event.pull_request.number }}/merge"
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## 運作方式

1. 安裝 `gh` CLI 擴充功能 `actions/gh-actions-cache`
2. 列出指定分支的所有快取鍵（最多 100 個項目）
3. 刪除找到的每個快取鍵
4. 使用 `set +e` 防止快取刪除遇到錯誤時導致工作流程失敗

## 範例工作流程

一個完整的工作流程範例，在 PR 關閉時清理快取：

```yaml
name: Cleanup PR Caches

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Cleanup PR caches
        uses: chia1104/chiastack.dev/.github/actions/clean-pr-cache@main
        with:
          REPO: ${{ github.repository }}
          BRANCH: "refs/pull/${{ github.event.pull_request.number }}/merge"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## 權限

此 action 需要以下權限：

- `actions: write` - 刪除快取項目

請確保您的工作流程已配置這些權限：

```yaml
permissions:
  actions: write
```

## 注意事項

- 即使沒有找到快取鍵，action 也會成功退出
- 快取刪除錯誤不會導致工作流程失敗（使用 `set +e`）
- action 可以處理每個分支最多 100 個快取項目
- `GH_TOKEN` 可以是預設的 `GITHUB_TOKEN` 或具有適當權限的自訂 token

